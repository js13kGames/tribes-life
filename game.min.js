window.requestAnimFrame=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(e){window.setTimeout(e,1e3/60)}}();var Gfx=function(){};Gfx.prototype.init=function(e){this.loaded=0;this.sprites={logo:new Image,pointer:new Image,tileset:new Image};this.sprites.logo.src="sprites/tribes_logo.png";this.sprites.pointer.src="sprites/pointer.png";this.sprites.tileset.src="sprites/tileset.png";for(var t in this.sprites){this.sprites[t].onload=function(){game.gfx.loaded++}}for(var n=0;n<e.layers;n++){var r=document.createElement("canvas");r.width=game.screen.width;r.height=game.screen.height;var i=r.getContext("2d");game.layers.push({canvas:r,ctx:i,render:false});r.style.webkitTransform=" scale("+game.screen.scale+")";document.getElementById("game").appendChild(r)}};Gfx.prototype.load=function(){var e=0,t;for(t in this.sprites){if(this.sprites.hasOwnProperty(t))e++}if(this.loaded>=e){game.gfx.init_tileset();return true}return false};Gfx.prototype.clear=function(e){game.layers[e].ctx.clearRect(0,0,game.screen.width,game.screen.height)};Gfx.prototype.init_tileset=function(){var e=document.createElement("canvas");e.width=this.sprites.tileset.width;e.height=this.sprites.tileset.height;var t=e.getContext("2d");t.drawImage(this.sprites.tileset,0,0);this.tileset=[];for(var n=0;n<e.height/game.world.sprite_size;n++){for(var r=0;r<e.width/game.world.sprite_size;r++){this.tileset.push(t.getImageData(game.world.sprite_size*r,game.world.sprite_size*n,game.world.sprite_size,game.world.sprite_size))}}};Gfx.prototype.draw_tileset=function(){for(var e=0;e<this.tileset.length;e++){this.put_tile({id:e,x:e,y:0,layer:1});game.layers[1].render=true}};Gfx.prototype.put_tile=function(e){game.layers[e.layer].ctx.putImageData(this.tileset[e.id],e.x*game.world.sprite_size,e.y*game.world.sprite_size)};var Gui=function(){};Gui.prototype.init=function(e){this.layer=e.layer;this.bubbles=[];this.conversation_time=30};Gui.prototype.clear=function(){game.layers[this.layer].ctx.clearRect(0,0,game.screen.width,game.screen.height)};Gui.prototype.draw_logo=function(e){game.layers[this.layer].ctx.drawImage(game.gfx.sprites.logo,e.x*game.world.sprite_size-24,e.y*game.world.sprite_size-8)};Gui.prototype.draw_intro=function(e){var t=game.layers[this.layer].ctx;t.textBaseline="bottom";t.textAlign="center";t.fillStyle="#fff";t.font="900 11px 'Source Code Pro', monospace,serif";t.strokeStyle="#fff";t.fillText("P1X PRESENTS",game.screen.width*.5<<0,(game.screen.height*.5<<0)-36);t.drawImage(game.gfx.sprites.logo,(game.screen.width*.5<<0)-24,(game.screen.height*.5<<0)-30);t.beginPath();t.moveTo(24,game.screen.height*.5<<0);t.lineTo(game.screen.width-24,game.screen.height*.5<<0);t.stroke();t.fillText("8X8 SPRITES; 16 COLOUR PALETTE",game.screen.width*.5<<0,(game.screen.height*.5<<0)+18);game.layers[this.layer].ctx.fillText("P1X ENGINE V4; ZIP < 13KB",game.screen.width*.5<<0,(game.screen.height*.5<<0)+32);t.fillText("#JS13KGAMES",game.screen.width*.5<<0,(game.screen.height*.5<<0)+48);t.beginPath();t.moveTo(24,(game.screen.height*.5<<0)+56);t.lineTo(game.screen.width-24,(game.screen.height*.5<<0)+56);t.stroke();if(game.timer%2==1){t.fillText("CLICK TO START",game.screen.width*.5<<0,(game.screen.height*.5<<0)+74)}};Gui.prototype.draw_fps=function(){var e=game.layers[this.layer].ctx;e.fillStyle="#000";e.fillRect(game.screen.width-7*game.world.sprite_size,game.screen.height-2*game.world.sprite_size,game.world.sprite_size*6,game.world.sprite_size);e.fillStyle="#fff";e.font="900 9px 'Source Code Pro', monospace,serif";e.textBaseline="bottom";e.textAlign="right";e.fillText("FPS "+game.fps,game.screen.width-game.world.sprite_size-2,game.screen.height-game.world.sprite_size+1)};Gui.prototype.draw_pointer=function(){var e=game.pointer.pos.x/game.screen.scale<<0,t=game.pointer.pos.y/game.screen.scale<<0;game.layers[this.layer].ctx.drawImage(game.gfx.sprites.pointer,game.pointer.enable?8:0,0,8,8,e,t,8,8)};Gui.prototype.draw_message=function(e){var t=game.layers[this.layer].ctx,n=0,r={},i=0,s=0,o,u,a,f,l;for(a=0;a<e.msg.length;a++){s=e.msg[a].length;if(s>i)i=s}o=(i/7.5*4.8<<0)+1;u=a+1;if(o<2)o=2;r={x:e.x-o+1,y:e.y-u+1};for(f=0;f<o;f++){for(l=0;l<u;l++){if(l===0){if(f===0)n=20;if(f===o-1)n=22;if(f>0&&f<o-1)n=21}if(u>2&&l>0){if(f===0)n=23;if(f===o-1)n=25;if(f>0&&f<o-1)n=24}if(l===u-1){if(f===0)n=26;if(f===o-1)n=28;if(f>0&&f<o-1)n=27}game.gfx.put_tile({layer:this.layer,id:n,x:r.x+f,y:r.y+l})}}t.fillStyle="#000";t.font="900 8px 'Source Code Pro', monospace,serif";t.textBaseline="top";t.textAlign="left";for(var a=0;a<e.msg.length;a++){t.fillText(e.msg[a],r.x*game.world.sprite_size+3,(r.y+a)*game.world.sprite_size+2)}};Gui.prototype.conversation=function(e){for(var t=0;t<e.bubbles.length;t++){this.bubbles.push({msg:e.bubbles[t],pos:{x:e.pos.x,y:e.pos.y},delay:t===0?e.delay||false:false,time:this.conversation_time})}};Gui.prototype.draw_conversation=function(){var e;if(this.bubbles.length>0){bubble=this.bubbles[0];if(bubble.delay&&bubble.delay<0){if(bubble.time<0){this.draw_message({msg:bubble.msg,x:bubble.pos.x,y:bubble.pos.y});if(game.pointer.enable){this.bubbles.splice(0,1)}}else{bubble.time--}}else{bubble.delay--}}};var Input=function(){};Input.prototype.init=function(){document.body.addEventListener("mousedown",this.enable_pointer,false);document.body.addEventListener("mouseup",this.disable_pointer,false);document.body.addEventListener("mousemove",this.track_pointer,false);document.body.addEventListener("contextmenu",function(e){e.preventDefault()},false)};Input.prototype.enable_pointer=function(e){e.preventDefault();var t,n;if(e.touches){t=e.touches[0].pageX;n=e.touches[0].pageY}else{t=e.pageX;n=e.pageY}game.pointer.enable=true};Input.prototype.disable_pointer=function(){game.pointer.enable=false};Input.prototype.track_pointer=function(e){e.preventDefault();var t,n;if(e.touches){t=e.touches[0].pageX;n=e.touches[0].pageY}else{t=e.pageX;n=e.pageY}game.pointer.pos.x=t;game.pointer.pos.y=n;if(game.pointer.enable){}};var Entity=function(){};var game={gfx:new Gfx,gui:new Gui,input:new Input,fps:0,layers:[],canvas:null,ctx:null,screen:{width:null,height:null,scale:4},world:{sprite_size:8,width:null,height:null,islands:[],entities:[]},pointer:{enable:false,pos:{x:null,y:null}},state:"loading",timer:0,init:function(){this.screen.width=window.innerWidth/this.screen.scale<<0;this.screen.height=window.innerHeight/this.screen.scale<<0;this.world.width=this.screen.width/this.world.sprite_size<<0;this.world.height=this.screen.height/this.world.sprite_size<<0;window.setInterval(game.inc_timer,500);this.gfx.init({layers:4});this.gui.init({layer:3});this.input.init()},generate_island:function(e){this.world.islands.push({pos:{x:(this.world.width*.5<<0)-3,y:(this.world.height*.5<<0)-3},data:[[6,2,3,2,3,7,0,0],[3,2,12,13,10,2,7,0],[8,10,12,12,11,10,2,7],[0,2,11,13,12,3,10,2],[6,10,3,12,10,11,3,9],[2,3,2,11,2,2,9,0],[8,4,5,4,5,9,0,0]]});this.world.entities.push({sprite:17,pos:{x:(this.world.width*.5<<0)-1,y:(this.world.height*.5<<0)+1}});this.world.entities.push({sprite:15,pos:{x:(this.world.width*.5<<0)+3,y:(this.world.height*.5<<0)-1}});this.world.entities.push({sprite:18,pos:{x:(this.world.width*.5<<0)-2,y:(this.world.height*.5<<0)+2}});this.world.entities.push({sprite:14,pos:{x:(this.world.width*.5<<0)+1,y:(this.world.height*.5<<0)-3}});this.world.entities.push({sprite:16,pos:{x:(this.world.width*.5<<0)-2,y:(this.world.height*.5<<0)-2}})},inc_timer:function(){game.timer++},new_game:function(){this.pointer.enable=false;this.generate_island();this.layers[0].render=true;this.layers[1].render=true;this.layers[2].render=true;this.timer=0;this.gui.conversation({bubbles:[["Hello, there!"],["Welcome to our","little island."]],pos:{x:(this.world.width*.5<<0)-2,y:(this.world.height*.5<<0)-3},delay:150});this.gui.conversation({bubbles:[["We are low in","food supply.."],["We shoud go","for hunting!"],["Lead us to","the animals."]],pos:{x:(this.world.width*.5<<0)-1,y:this.world.height*.5<<0},delay:80})},update:function(e){switch(this.state){case"loading":if(this.gfx.load()){this.state="intro"}break;case"intro":if(this.pointer.enable){this.new_game();this.state="game"}break;case"game":break;case"game_over":if(this.pointer.enable){this.new_game();this.state="game"}break}},render:function(e){this.gui.clear();var t,n,r;switch(this.state){case"intro":this.gui.draw_intro();break;case"game":if(this.layers[0].render){for(n=0;n<this.world.width;n++){for(r=0;r<this.world.height;r++){this.gfx.put_tile({id:Math.random()<.5?0:1,x:n,y:r,layer:0})}}this.layers[0].render=false}for(var t=0;t<32;t++){this.gfx.put_tile({id:Math.random()<.5?0:1,x:Math.random()*this.world.width<<0,y:Math.random()*this.world.height<<0,layer:0})}if(this.layers[1].render){for(t=0;t<this.world.islands.length;t++){var i=this.world.islands[t];for(r=0;r<i.data.length;r++){for(n=0;n<i.data[r].length;n++){if(i.data[r][n]>0){this.gfx.put_tile({id:i.data[r][n],x:i.pos.x+n,y:i.pos.y+r,layer:1})}}}}this.layers[1].render=false}if(this.layers[2].render){for(t in this.world.entities){var s=this.world.entities[t];this.gfx.put_tile({id:s.sprite,x:s.pos.x,y:s.pos.y,layer:2})}this.layers[2].render=false}this.gui.draw_fps();this.gui.draw_logo({x:4,y:this.world.height-2});this.gui.draw_conversation();break;case"game_over":this.gui.draw_game_over();break}this.gui.draw_pointer()},loop:function(e){this.update(e);this.render(e)}};game.init();var time,fps=0,last_update=new Date*1-1,fps_filter=30;(function e(){requestAnimFrame(e);var t=(new Date).getTime(),n=t-(time||t);time=t;var r=1e3/((t=new Date)-last_update);fps+=(r-fps)/fps_filter;last_update=t;game.fps=fps.toFixed(1);game.loop(n)})()