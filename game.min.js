window.requestAnimFrame=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(e){window.setTimeout(e,1e3/60)}}();var Gfx=function(){};Gfx.prototype.init=function(e){this.loaded=0;this.sprites={logo:new Image,pointer:new Image,tileset:new Image};this.sprites.logo.src="sprites/tribes_logo.png";this.sprites.pointer.src="sprites/pointer.png";this.sprites.tileset.src="sprites/tileset.png";for(var t in this.sprites){this.sprites[t].onload=function(){game.gfx.loaded++}}for(var n=0;n<e.layers;n++){var r=document.createElement("canvas");r.width=game.screen.width;r.height=game.screen.height;var i=r.getContext("2d");game.layers.push({canvas:r,ctx:i,render:false});document.getElementById("game").appendChild(r)}};Gfx.prototype.load=function(){var e=0,t;for(t in this.sprites){if(this.sprites.hasOwnProperty(t))e++}if(this.loaded>=e){game.gfx.init_tileset();return true}return false};Gfx.prototype.clear=function(e){game.layers[e].ctx.clearRect(0,0,game.screen.width,game.screen.height)};Gfx.prototype.init_tileset=function(){var e=document.createElement("canvas");e.width=this.sprites.tileset.width;e.height=this.sprites.tileset.height;var t=e.getContext("2d");t.drawImage(this.sprites.tileset,0,0);this.tileset=[];for(var n=0;n<e.height/game.world.sprite_size;n++){for(var r=0;r<e.width/game.world.sprite_size;r++){this.tileset.push(t.getImageData(game.world.sprite_size*r,game.world.sprite_size*n,game.world.sprite_size,game.world.sprite_size))}}};Gfx.prototype.draw_tileset=function(){for(var e=0;e<this.tileset.length;e++){this.put_tile({id:e,x:e,y:0,layer:1});game.layers[1].render=true}};Gfx.prototype.put_tile=function(e){game.layers[e.layer].ctx.putImageData(this.tileset[e.id],e.x*game.world.sprite_size,e.y*game.world.sprite_size)};var Gui=function(){};Gui.prototype.init=function(e){this.layer=e.layer};Gui.prototype.clear=function(){game.layers[this.layer].ctx.clearRect(0,0,game.screen.width,game.screen.height)};Gui.prototype.draw_logo=function(e){game.layers[this.layer].ctx.drawImage(game.gfx.sprites.logo,e.x*game.world.sprite_size-24,e.y*game.world.sprite_size-8)};Gui.prototype.draw_intro=function(e){var t=game.layers[this.layer].ctx;t.textBaseline="bottom";t.textAlign="center";t.fillStyle="#fff";t.font="bold 10px sans-serif";t.strokeStyle="#fff";t.fillText("P1X PRESENTS",game.screen.width*.5<<0,(game.screen.height*.5<<0)-36);t.drawImage(game.gfx.sprites.logo,(game.screen.width*.5<<0)-24,(game.screen.height*.5<<0)-8);game.layers[this.layer].ctx.beginPath();game.layers[this.layer].ctx.moveTo(24,(game.screen.height*.5<<0)+32);game.layers[this.layer].ctx.lineTo(game.screen.width-24,(game.screen.height*.5<<0)+32);game.layers[this.layer].ctx.stroke();game.layers[this.layer].ctx.fillText("JS13KGAME COMPO",game.screen.width*.5<<0,(game.screen.height*.5<<0)+54);if(game.timer%2==1){game.layers[this.layer].ctx.fillText("CLICK TO START",game.screen.width*.5<<0,(game.screen.height*.5<<0)+70)}t.beginPath();t.moveTo(24,(game.screen.height*.5<<0)+80);t.lineTo(game.screen.width-24,(game.screen.height*.5<<0)+80);t.stroke()};Gui.prototype.draw_fps=function(){var e=game.layers[this.layer].ctx;e.fillStyle="#000";e.fillRect(game.screen.width-5*game.world.sprite_size,game.screen.height-2*game.world.sprite_size,game.world.sprite_size*4,game.world.sprite_size);e.fillStyle="#fff";e.font="bold 8px sans-serif";e.textBaseline="bottom";e.textAlign="right";e.fillText("FPS:"+game.fps,game.screen.width-game.world.sprite_size+1,game.screen.height-game.world.sprite_size+1)};Gui.prototype.draw_pointer=function(){var e=game.pointer.pos.x/game.screen.scale<<0,t=game.pointer.pos.y/game.screen.scale<<0;game.layers[this.layer].ctx.drawImage(game.gfx.sprites.pointer,e,t)};var Input=function(){};Input.prototype.init=function(){document.body.addEventListener("mousedown",this.enable_pointer,false);document.body.addEventListener("mouseup",this.disable_pointer,false);document.body.addEventListener("mousemove",this.track_pointer,false);document.body.addEventListener("contextmenu",function(e){e.preventDefault()},false)};Input.prototype.enable_pointer=function(e){e.preventDefault();var t,n;if(e.touches){t=e.touches[0].pageX;n=e.touches[0].pageY}else{t=e.pageX;n=e.pageY}game.pointer.enable=true};Input.prototype.disable_pointer=function(){game.pointer.enable=false};Input.prototype.track_pointer=function(e){e.preventDefault();var t,n;if(e.touches){t=e.touches[0].pageX;n=e.touches[0].pageY}else{t=e.pageX;n=e.pageY}game.pointer.pos.x=t;game.pointer.pos.y=n;if(game.pointer.enable){}};var game={gfx:new Gfx,gui:new Gui,input:new Input,fps:0,layers:[],canvas:null,ctx:null,screen:{width:null,height:null,scale:4},world:{sprite_size:8,width:null,height:null,islands:[]},pointer:{enable:false,pos:{x:null,y:null}},state:"loading",timer:0,init:function(){this.screen.width=window.innerWidth/this.screen.scale<<0;this.screen.height=window.innerHeight/this.screen.scale<<0;this.world.width=this.screen.width/this.world.sprite_size<<0;this.world.height=this.screen.height/this.world.sprite_size<<0;window.setInterval(game.inc_timer,500);this.gfx.init({layers:3});this.gui.init({layer:2});this.input.init()},generate_island:function(e){this.world.islands.push({pos:{x:(this.world.width*.5<<0)-3,y:(this.world.height*.5<<0)-3},data:[[2,0,0,1,0,3],[0,1,10,10,0,0],[1,0,10,10,1,0],[0,10,1,10,10,1],[0,1,0,1,10,0],[4,0,1,0,0,5]]})},inc_timer:function(){game.timer++},new_game:function(){this.pointer.enable=false;this.generate_island();this.layers[0].render=true;this.timer=0},update:function(e){switch(this.state){case"loading":if(this.gfx.load()){this.state="intro"}break;case"intro":if(this.pointer.enable){this.new_game();this.state="game"}break;case"game":break;case"game_over":if(this.pointer.enable){this.new_game();this.state="game"}break}},render:function(e){this.gui.clear();var t,n,r;switch(this.state){case"intro":this.gui.draw_intro();break;case"game":if(this.layers[0].render){for(n=0;n<this.world.width;n++){for(r=0;r<this.world.height;r++){this.gfx.put_tile({id:6,x:n,y:r,layer:0})}}for(t=0;t<this.world.islands.length;t++){var i=this.world.islands[t];for(n=0;n<i.data.length;n++){for(r=0;r<i.data[n].length;r++){this.gfx.put_tile({id:i.data[r][n],x:i.pos.x+n,y:i.pos.y+r,layer:0})}}}this.layers[0].render=false}if(this.layers[1].render){for(n=0;n<this.world.width;n++){for(r=0;r<this.world.height;r++){}}this.layers[1].render=false}this.gui.draw_fps();this.gui.draw_logo({x:this.world.width*.5<<0,y:2});break;case"game_over":this.gui.draw_game_over();break}this.gui.draw_pointer()},loop:function(e){this.update(e);this.render(e)}};game.init();var time,fps=0,last_update=new Date*1-1,fps_filter=30;(function e(){requestAnimFrame(e);var t=(new Date).getTime(),n=t-(time||t);time=t;var r=1e3/((t=new Date)-last_update);fps+=(r-fps)/fps_filter;last_update=t;game.fps=fps.toFixed(1);game.loop(n)})()